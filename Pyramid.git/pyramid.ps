%!
% Pyramidal Fractal in PostScript
%
% Draws a 3-D pyramid fractal, as seen in a popular text on Fractals
%
% Initial version from 1995
%   Curt.McDowell@andrew.cmu.edu
%   Carnegie-Mellon University
%
% Updated 2020
%   Curt McDowell <coder@fishlet.com>
%

72 72 scale
0.5 72 div setlinewidth

% Coordinate systems
%
%    3D: x goes right, y goes back into screen, z goes up
%    2D: x goes right, y goes down
%
% User-Adjustable Parameters:
%
% Adjust viewing angle by modifying alpha and beta.
% The pyramid is originally seen level with the front edge.
% It is then rotated around the Z axis by alpha
% (front corner moving right), then around the Y (horizonal)
% axis by beta (top corner moving down).
%
% The pyramid is defined by four points, and is broken into
% sub-pyramids by connecting the midpoints of the six edges.

%/Alpha		50    def	/Beta		75    def
/Alpha		15    def	/Beta		15    def
/ShadeLeft	0.95  def	/ShadeRight	0.5   def
/PageW		8.5   def	/PageH		11    def
/Side		0.65  def	/Order		5     def

0 -1 translate

/sina Alpha sin def	/sinb Beta sin def
/cosa Alpha cos def	/cosb Beta cos def

% Transform a 3D point q into a 2D point p
/xform {	% q ==> p
    3 dict begin   aload pop   /z exch def   /y exch def   /x exch def
    [
	% screen x
	y cosa mul x sina mul sub
%	x
	PageW 2 div mul
	PageW 2 div add

	% screen  y
	%x sinb mul cosa mul y sina mul sinb mul add z cosb mul add
	z neg
	PageW 2 div mul
	PageH 2 div add
    ]
    end
} def

% Take the midpoint of a line between two 3D points
/mid {		% q1 q2 ==> (q1 + q2) / 2
    2 dict begin   /q2 exch def   /q1 exch def
    [
        q1 0 get   q2 0 get   add   2 div
        q1 1 get   q2 1 get   add   2 div
        q1 2 get   q2 2 get   add   2 div
    ]
    end
} def

/pmoveto {	% p ==> --
    aload pop moveto
} def

/plineto {	% p ==> --
    aload pop lineto
} def

/pyramid {	% order q1 q2 q3 q4 order ==> --
    12 dict begin
    /q4 exch def   /q3 exch def   /q2 exch def   /q1 exch def  /order exch def
    order 1 gt { pyramid_sub } { pyramid_base } ifelse
    end
} def

/pyramid_sub {
    /q12 q1 q2 mid def
    /q13 q1 q3 mid def
    /q14 q1 q4 mid def
    /q23 q2 q3 mid def
    /q24 q2 q4 mid def
    /q34 q3 q4 mid def

    /order' order 1 sub def

    order' q1  q12 q13 q14 pyramid
    order' q12 q2  q23 q24 pyramid
    order' q14 q24 q34 q4  pyramid
    order' q13 q23 q3  q34 pyramid
} def

/pyramid_base {
    /p1 q1 xform def  % bottom front
    /p2 q2 xform def  % bottom left
    /p3 q3 xform def  % top
    /p4 q4 xform def  % bottom right

    % Fill the two visible faces with different shades

    ShadeLeft setgray
    p2 pmoveto   p1 plineto   p3 plineto   closepath fill

    ShadeRight setgray
    p4 pmoveto   p1 plineto   p3 plineto   closepath fill

    % Draw the five visible line segments

    0 setgray
    p2 pmoveto   p1 plineto   p4 plineto   p3 plineto
    closepath    p3 pmoveto   p1 plineto   stroke
} def

/rp Side def
/rn rp neg def

Order [rp rp rp] [rp rn rn] [rn rn rp] [rn rp rn]
pyramid

showpage
